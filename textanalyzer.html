<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Textanalyzer</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


    <script src="jquery.json-view.js"></script>

    <link href="jquery.json-view.css" rel="stylesheet">


    <script>
        function updateText(log, searchStr, color) {

            return log.replace(new RegExp(searchStr, 'g'), '<mark style="background-color: ' + color + ';">' + searchStr + '</mark>');
        }

        function updateTextCSS(log, searchStr, css) {
            return log.replace(new RegExp(searchStr, 'g'), '<mark style="' + css + ';">' + searchStr + '</mark>');
        }

        function newLineText(log, searchStr) {
            return log.replace(new RegExp(searchStr, 'g'), '<br>' + searchStr);
        }

        function searchJson(log, counter) {
            //console.log("searchJson");
            var myJson = new Object();
            myJson.start = log.indexOf("{", counter);
            if (myJson.start < 0) {
                myJson.close = -1;
                return myJson;
            }
            var counters = new Object();
            counters.open = 1;
            counters.close = 0;
            counters.str = myJson.start + 1;
            do {
                if (log.indexOf("{", counters.str) > 0) {
                    if (log.indexOf("}", counters.str) < log.indexOf("{", counters.str)) {
                        counters.str = log.indexOf("}", counters.str) + 1;
                        counters.close++;
                        //console.log("strCounter {} close {} open {}", counters.str, close, open);

                    } else {
                        counters.open++;
                        counters.str = log.indexOf("{", counters.str) + 1;
                        // console.log("strCounter {} close {} open {}", counters.str, close, open);
                    }
                } else {
                    if (log.indexOf("}", counters.str) > 0 && myJson.start > 0) {
                        counters.str = log.indexOf("}", counters.str) + 1;
                        counters.close++;
                    } else {
                        return myJson;
                    }
                }
            } while (counters.open != counters.close || counters.str < 0);
            myJson.json = JSON.parse(log.substr(myJson.start, counters.str - myJson.start).replace(/\\/g, "/"));
            myJson.counters = counters;
            myJson.close = counters.str;
            console.log(myJson.json);
            return myJson;
            //search first {, count all open { and close } till -> 0 -> try to parse json
            //save json in var, remove it from string, add pre with id to str
            //http://jsfiddle.net/K83cK/
        }


        function useJson(log) {
            var jsonObj = [];
            var counter = 0;
            do {
                if (counter == 0) {
                    jsonObj[counter++] = searchJson(log, 0);
                } else {
                    var weiterfahren = jsonObj[counter - 1].close + 1;
                    jsonObj[counter++] = searchJson(log, weiterfahren);
                }
            } while (jsonObj[counter - 1].close > 0)
            // remove last unsuccessful element
            jsonObj.pop();
            return jsonObj;
        }

        function prettyPrintJsons(text, jsons) {
            var newHtml = text;
            for (var i = jsons.length; i > 0; i--) {
                var endStr = newHtml.substr(jsons[i - 1].close);
                var startStr = newHtml.substr(0, jsons[i - 1].start);
                newHtml = startStr + '<div id="json' + (i - 1) + '"></div>' + endStr;
            }
            $('#output').html(newHtml);
            for (var i = 0; i < jsons.length; i++) {
                // https://www.jqueryscript.net/other/jQuery-Based-Pretty-Collapsible-JSON-Tree-Viewer.html
                $("#json" + i).jsonView( jsons[i].json);
            }
        }

        $(document).ready(function () {
            $("#analyze-button").click(function () {
                console.log("analyze");
                var text = $('#log-comment').val();
                prettyPrintJsons(text,useJson(text, 0));
                text =  $('#output').html();
                var lines = $('#mark-comment').val().split('\n');
                if ($('#mark-comment').val().length > 0) {
                    for (var i = 0; i < lines.length; i++) {
                        var splitCommands = lines[i].split("=");
                        if (splitCommands[1] == "NEWLINE") {
                            text = newLineText(text, splitCommands[0]);
                        } else if (splitCommands[1] == "CSS" && splitCommands.length > 2) {
                            text = updateTextCSS(text, splitCommands[0], splitCommands[2]);
                            //console.log("CSS: "+text);
                        } else {
                            text = updateText(text, splitCommands[0], splitCommands[1]);
                        }
                    }
                    $('#output').html(text);

                } else {
                    $('#output').html(text);
                }
            });

        });
    </script>

    <style>
        button {
            margin-top: 5px;
        }

        .container {
            width: 99%;
        }

        #output {
            color: black;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="form-group">
        <label for="log-comment">Text to analyze:</label>
        <textarea class="form-control" rows="5" id="log-comment" placeholder="copy text to analyze here"></textarea>
        <label for="mark-comment">Marker:</label>
        <textarea class="form-control" rows="5" id="mark-comment"
                  placeholder="case sensitive, use all html colors and also hexnumbers, one command per line!! Examples:    searchstring=color      xxxx=NEWLINE          INFO=red        Thread=CSS=color:red; background-color: blue"></textarea>
        <button type="button" class="btn btn-block btn-success" id="analyze-button">
            Analyze
        </button>
    </div>


    <div class="alert alert-success" role="alert">
        <h4 class="alert-heading">Output:</h4>
        <hr>
        <p id="output"></p>
    </div>


</div>
</body>
</html>